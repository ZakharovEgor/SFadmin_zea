---
- hosts: ubuntu3.my
  become: yes
  tasks:

- name: Debian - Install apt-transport-https to support https APT downloads
  become: yes
  apt: name=apt-transport-https state=present
  when: es_use_repository | bool
  register: result
  until: result is not failed
  retries: 5
  delay: 10

- name: Debian - Add Elasticsearch repository key
  become: yes
  apt_key:
    url: "{{ es_apt_key }}"
    id: "{{ es_apt_key_id }}"
    state: present
  when: es_use_repository  | bool and es_apt_key is defined | bool
  register: result
  until: result is not failed
  retries: 5
  delay: 10

- name: Debian - Ensure {{ kibana_package_name }} is installed
  become: yes
  apt:
    name: '{{ kibana_package_name }}{% if es_version is defined and es_version %}={{ es_version }}{% endif %}'
    state: present
    force: '{{ force_install }}'
    allow_unauthenticated: "{{ 'no' if es_apt_key else 'yes' }}"
    cache_valid_time: 86400
  when: es_use_repository | bool
  register: debian_kibana_install_from_repo
  notify: restart kibana
  until: debian_kibana_install_from_repo is not failed
  retries: 5
  delay: 10



handlers:

- name: Debian - Ensure {{ kibana_package_name }} is installed
  become: yes
  apt:
    name: '{{ kibana_package_name }}{% if es_version is defined and es_version %}={{ es_version }}{% endif %}'
    state: present
    force: '{{ force_install }}'
    allow_unauthenticated: "{{ 'no' if es_apt_key else 'yes' }}"
    cache_valid_time: 86400
  when: es_use_repository | bool
  register: debian_kibana_install_from_repo
  notify: restart kibana
  until: debian_kibana_install_from_repo is not failed
  retries: 5
  delay: 10